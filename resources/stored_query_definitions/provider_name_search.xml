<careServicesFunction xmlns="urn:ihe:iti:csd:2013" xmlns:hfp="http://www.w3.org/2001/XMLSchema-hasFacetAndProperty" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:csd="urn:ihe:iti:csd:2013" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:ihe:iti:csd:2013 CSD.xsd" content-type="text/xml" urn="urn:openhie.org:openinfoman-hwr:stored-function:provider_name_search">
  <description>
    <p> Performs a search for all providers by name, coded type, address or ID. </p>
    <p> The result set consists of all names  providers matching the <i>search parameters</i> ( <b>id</b>,
        <b>otherID</b>, <b>commonName</b>,<b>codedType</b> and <b>address</b> ). </p>
    <p> The results set may be further restricted according to the <i>limit parameters</i>
        (<b>start</b>, <b>max</b>, <b>record/@status</b> and <b>record/@updated</b>). An ordering of
      the result set is not specified. </p>
    <p>
      <h2>Response</h2> Results are returned as a valid CSD document with a root document element of
      &lt;CSD/&gt;. The results set is contained entirely within the &lt;providerDirectory/&gt;
      element and consists of the full content of the &lt;provider/&gt; elements of matching
      providers as maintained by the Care Services InfoManager. </p>
    <h2>Parameters</h2> Query Parameters are defined as the content of following elements: <ul>
      <li> &lt;id/&gt; <i>csd:uniqueID</i>: (optional) If present and the @urn attribute contains a
        non-empty value, it is a ID which uniquely identifies a provider. This is an exact match. </li>
      <li> &lt;otherID/&gt; <i>csd:otherID</i>: (optional) If present and the
        @assigningAuthorityName attribute contains a non-empty value, then the result set is
        restricted to only those providers which have a &lt;otherID/&gt; with the given
        assigingAuthorityName and @code </li> <li>&lt;commonName/&gt; <i>xsd:string</i>: (optional)
        If present and contains a non-empty value, then the result set should be restricted to those
        providers which have a &lt;demographic/name/commonName/&gt; containing this value. Case
        insensitive.</li>
      <li>&lt;codedType/&gt; <i>csd:codedtype</i>: If present and contains a non-empty value the
        result set should be restricted to those providers whose &lt;codeType/@code&gt; equals this
        value for the coding schema specified by the @codingSchema attribute. Case insensitive. </li>
      <li> &lt;address/&gt; <i>csd:address</i>: (optional) Contains of any-number of child
        &lt;addressLine/&gt; elements as follows: <ul>
          <li>Text content <i>xsd:string</i>: (optional) If present and contains a non-empty value,
            then the results set should be restricted to those providers whose have an
            &lt;addressLine/&gt; with specified @component containing this value exactly. Case
            insensitive. </li>
          <li>@component <i>xsd:string</i> : (Required attribute) The component of the address we
            are searching. Case insensitive.</li>
        </ul>
      </li>
      <li>&lt;start/&gt; <i> xsd:int</i>: (optional) The starting index for results returned.
        Defaults to 1, which indexes the first provider matching the search parameters</li>
      <li>&lt;max/&gt; <i> xsd:int</i>: (optional) The maximum number of results returned. A value
        of less than zero implies no maximum.</li>
      <li> &lt;record/&gt; <i> csd:record </i>: (optional) A child element to limit results
        according to <ul>
          <li>@status <i>xsd:string</i>: (optional) If present and contains a non-empty value, the
            result set should be restricted to those providers whose record/@status equals this
            value. Case insensitive.</li>
          <li>@updated <i>xsd:dateTime</i>: (optional) If present and contains a non-empty value,
            the result set should be restricted to those providers whose record/@updated is at least
            the given value.</li>
        </ul>
      </li>
    </ul>
    <h2>Example Request</h2>
    <pre>
         &lt;careServicesRequest&gt;
           &lt;function uuid='4e8bbeb9-f5f5-11e2-b778-0800200c9a66'&gt;
               &lt;codedType code="2221" codingSchema="ISCO-08" /&lt;
               &lt;address&gt;
                 &lt;addressLine component='city'&gt;Kigali&lt;/addressLine&gt;
	       &lt;/address&gt;
               &lt;max&gt;5&lt;/max&gt;
           &lt;/function&gt;
         &lt;/careServicesRequest&gt;         
      </pre>
  </description>
  <definition>
    <xi:include parse="text" href="provider_name_search.xq"/>
  </definition>
  <xforms:model id="urn:openhie.org:openinfoman-hwr:stored-function:provider_name_search">
    <xforms:instance id="care-services-result">
      <csd:careSerivcesResponse id="" code="" content-type=""/>
    </xforms:instance>
    <xforms:instance id="http-post-request">
      <csd:requestParams>
        <id/>
        <otherID/>
        <commonName/>
        <codedType/>
        <address/>
        <start/>
        <max/>
        <record/>
      </csd:requestParams>
    </xforms:instance>
    <xforms:instance id="http-post-response">
      <http:result xmlns:http="http://expath.org/ns/http-client" status="">
        <http:header name="X-CSD-Transaction-ID" value=""/>
        <http:body/>
      </http:result>
    </xforms:instance>
    <xforms:instance id="soap-request">
      <soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope">
        <soap:Header>
          <wsa:Action xmlns:wsa="http://www.w3.org/2005/08/addressing" soap:mustUnderstand="1">urn:ihe:iti:csd:2013:GetCareServicesRequest</wsa:Action>
          <wsa:MessageID xmlns:wsa="http://www.w3.org/2005/08/addressing"/>
          <wsa:ReplyTo xmlns:wsa="http://www.w3.org/2005/08/addressing" soap:mustUnderstand="1">
            <wsa:Address>http://www.w3.org/2005/08/addressing/anonymous</wsa:Address>
          </wsa:ReplyTo>
          <wsa:To xmlns:wsa="http://www.w3.org/2005/08/addressing" soap:mustUnderstand="1">{$LOCATION}</wsa:To>
        </soap:Header>
        <soap:Body>
          <csd:careServicesRequest urn="urn:openhie.org:openinfoman-hwr:stored-function:provider_name_search">
            <csd:requestParams>
              <id/>
              <otherID/>
              <commonName/>
              <codedType/>
              <address/>
              <start/>
              <max/>
              <record/>
            </csd:requestParams>
          </csd:careServicesRequest>
        </soap:Body>
      </soap:Envelope>
    </xforms:instance>
    <xforms:instance id="soap-response">
      <soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope">
        <soap:Header>
          <wsa:Action xmlns:wsa="http://www.w3.org/2005/08/addressing" soap:mustUnderstand="1">urn:ihe:iti:csd:2013:GetCareServicesResponse</wsa:Action>
          <wsa:MessageID xmlns:wsa="http://www.w3.org/2005/08/addressing"/>
          <wsa:ReplyTo xmlns:wsa="http://www.w3.org/2005/08/addressing" soap:mustUnderstand="1">
            <wsa:Address>http://www.w3.org/2005/08/addressing/anonymous</wsa:Address>
          </wsa:ReplyTo>
          <wsa:RelatesTo xmlns:wsa="http://www.w3.org/2005/08/addressing"/>
        </soap:Header>
        <soap:Body>
          <csd:careServicesResponse/>
        </soap:Body>
      </soap:Envelope>
    </xforms:instance>
    <xforms:submission id="soap-submission" method="post" mediatype="application/soap+xml" ref="instance('soap-request')" resource="{$LOCATION}"/>
    <xforms:submission id="http-post-submission" method="post" mediatype="text/xml" ref="instance('http-post-request')" resource="{$LOCATION}/urn:openhie.org:openinfoman-hwr:stored-function:provider_name_search"/>
    <xforms:action ev:event="xforms-submit-done" id="http-post-prepare">
      <xforms:insert context="instance('http-post-response')/http:result/http:body" origin="instance('care-services-result')/csd:careServicesResponse/csd:result/*"/>
      <xforms:setValue bind="instance('http-post-response')/http:result/@status" value="instance('care-services-result')/csd:careServicesResponse/@code"/>
      <xforms:setValue bind="instance('http-post-response')/http:body/@content-type" value="instance('care-services-result')/csd:careServicesResponse/@content-type"/>
      <xforms:setValue bind="instance('http-post-response')/http:result/http:header[@name='X-CSD-Transaction-ID']/@value" value="instance('care-services-result')/csd:careServicesResponse/@id"/>
    </xforms:action>
    <xforms:action ev:event="xforms-submit-done" id="soap-prepare">
      <xforms:insert context="instance('soap-response')/soap:Envelope/soap:Body/csd:careServicesResponse/csd:result" origin="instance('care-services-result')/csd:careServicesRepsonse/csd:result/*"/>
      <xforms:insert context="instance('soap-response')/soap:Envelope/soap:Body/csd:careServicesResponse/@content-type" origin="instance('care-services-result')/csd:careServicesRepsonse/@content-type"/>
      <xforms:insert context="instance('soap-response')/soap:Envelope/soap:Body/csd:careServicesResponse/@code" origin="instance('care-services-result')/csd:careServicesRepsonse/@code"/>
      <xforms:setValue bind="instance('soap-response')/soap:Envelope/soap:Header/wsa:messageID" value="instance('soap-request')/csd:careServicesRequest/@id"/>
      <xforms:setValue bind="instance('soap-response')/soap:Envelope/soap:Header/wsa:relatesTo" value="instance('soap-request')/soap:Envelope/soap:Header/wsa:messageID"/>
    </xforms:action>
    <xforms:bind nodeset="instance('http-post-request')/" type="csd:uniqueID"/>
    <xforms:bind nodeset="instance('soap-request')/soap:Envelope/soap:Header/soap:Body/csd:careServicesRequest/" type="csd:uniqueID"/>
    <xforms:bind nodeset="instance('http-post-request')/" type="csd:otherID"/>
    <xforms:bind nodeset="instance('soap-request')/soap:Envelope/soap:Header/soap:Body/csd:careServicesRequest/" type="csd:otherID"/>
    <xforms:bind nodeset="instance('http-post-request')/" type="xsd:string"/>
    <xforms:bind nodeset="instance('soap-request')/soap:Envelope/soap:Header/soap:Body/csd:careServicesRequest/" type="xsd:string"/>
    <xforms:bind nodeset="instance('http-post-request')/" type="csd:codedtype"/>
    <xforms:bind nodeset="instance('soap-request')/soap:Envelope/soap:Header/soap:Body/csd:careServicesRequest/" type="csd:codedtype"/>
    <xforms:bind nodeset="instance('http-post-request')/" type="csd:address"/>
    <xforms:bind nodeset="instance('soap-request')/soap:Envelope/soap:Header/soap:Body/csd:careServicesRequest/" type="csd:address"/>
    <xforms:bind nodeset="instance('http-post-request')/" type="xsd:int"/>
    <xforms:bind nodeset="instance('soap-request')/soap:Envelope/soap:Header/soap:Body/csd:careServicesRequest/" type="xsd:int"/>
    <xforms:bind nodeset="instance('http-post-request')/" type="xsd:int"/>
    <xforms:bind nodeset="instance('soap-request')/soap:Envelope/soap:Header/soap:Body/csd:careServicesRequest/" type="xsd:int"/>
    <xforms:bind nodeset="instance('http-post-request')/" type="csd:record"/>
    <xforms:bind nodeset="instance('soap-request')/soap:Envelope/soap:Header/soap:Body/csd:careServicesRequest/" type="csd:record"/>
  </xforms:model>
  
  
  
  
  
  
  
  
  
</careServicesFunction>